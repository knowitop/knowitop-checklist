function ChecklistAPI(t){this.url=t.url,this.hostId=t.hostId,this.hostClass=t.hostClass,this.oqlFilter=t.oqlFilter,this.post=function(t,i){t.host_id=this.hostId,t.host_class=this.hostClass,$.post(this.url,t,function(e){try{var t=JSON.parse(e)}catch(t){return i(new Error(e))}return!1!==t.error?i(new Error(t.message)):i(null,t)})}}function Checklist(t){this.container=t.container?$(t.container):$("[data-checklist-id='"+t.id+"']"),this.titleContainer=this.container.find(".checklist-title"),this.titleInput=this.container.find("input[name='listTitle']"),this.newItemContainer=this.container.find(".checklist-new-item"),this.newItemInput=this.container.find("input[name='newItemText']"),this.id=t.id||this.container.data("checklist-id"),this.title=t.title||this.titleInput.val(),this.items=[],this.initItems(),this.setListeners()}function ChecklistItem(t){this.container=t.container?$(t.container):$("[data-item-id='"+t.id+"']"),this.checkbox=this.container.find("input[name='itemState']"),this.textInput=this.container.find("input[name='itemText']"),this.listId=t.listId,this.id=t.id||this.container.data("item-id"),this.text=t.text||this.textInput.val(),this.state=t.state||this.checkbox.prop("checked"),this.setListeners()}Checklist.prototype.remove=function(){var t={operation:"remove_list",checklist_id:this.id};checklistApi.post(t,function(t,e){t?(alert(t.message),console.error(t.message)):this.container.remove()}.bind(this))},Checklist.prototype.saveTitle=function(){var t={operation:"edit_list",checklist_id:this.id,title:this.titleInput.val()};if(""===t.title.trim())return this.titleInput.focus();checklistApi.post(t,function(t,e){t?(alert(t.message),console.error(t.message)):(this.titleInput.width(160),this.title=this.titleInput.val(),this.titleContainer.children(".checklist-title-text").text(this.title),this.titleContainer.removeClass("checklist-title-edit-mode"))}.bind(this))},Checklist.prototype.editTitle=function(){this.titleInput.width(Math.max(this.titleInput.width(),this.titleContainer.children(".checklist-title-text").width()+5)),this.titleContainer.addClass("checklist-title-edit-mode"),this.titleInput.focus()},Checklist.prototype.cancelTitle=function(){this.titleInput.val(this.title),this.titleContainer.removeClass("checklist-title-edit-mode")},Checklist.prototype.saveItem=function(){var t={operation:"add_item",checklist_id:this.id,text:this.newItemInput.val()};if(""===t.text.trim())return this.newItemInput.focus();checklistApi.post(t,function(t,e){t?(alert(t.message),console.error(t.message)):(this.container.find(".checklist-items").append("<li>"+e.html+"</li>"),this.items.push(new ChecklistItem({id:e.id,listId:this.id})),this.newItemInput.val(""))}.bind(this))},Checklist.prototype.newItem=function(){this.newItemContainer.addClass("checklist-item-edit-mode"),this.newItemInput.focus()},Checklist.prototype.cancelItem=function(){this.newItemInput.val(""),this.newItemContainer.removeClass("checklist-item-edit-mode")},Checklist.prototype.setListeners=function(){this.newItemContainer.find("a.checklist-btn").click(function(t){switch($(t.target).data("checklist-action")){case"new_item":this.newItem();break;case"save_item":this.saveItem();break;case"cancel_item":this.cancelItem()}}.bind(this)),this.newItemInput.keydown(function(t){13===t.keyCode?(t.preventDefault(),this.saveItem()):27===t.keyCode&&(t.preventDefault(),this.cancelItem())}.bind(this)),this.titleContainer.find("a.checklist-btn").click(function(t){switch($(t.target).data("checklist-action")){case"edit":this.editTitle();break;case"save":this.saveTitle();break;case"cancel":this.cancelTitle();break;case"delete":var e=Dict.S("UI:Checklist:DeleteDlg:Msg"),i=this;$("<div>"+e+"</div>").dialog({modal:!0,title:Dict.S("UI:Checklist:DeleteDlg:Title"),close:function(){$(this).remove()},minWidth:400,buttons:[{text:Dict.S("UI:Checklist:DeleteDlg:Cancel"),click:function(){$(this).dialog("close")}},{text:Dict.S("UI:Checklist:DeleteDlg:Delete"),click:function(){i.remove(),$(this).dialog("close")}}]})}}.bind(this)),this.titleInput.keydown(function(t){13===t.keyCode?(t.preventDefault(),this.saveTitle()):27===t.keyCode&&(t.preventDefault(),this.cancelTitle())}.bind(this))},Checklist.prototype.initItems=function(){this.container.find(".checklist-item").each(function(t,e){this.items.push(new ChecklistItem({container:e,listId:this.id}))}.bind(this))},ChecklistItem.prototype.setListeners=function(){this.checkbox.change(function(){this.state=!this.state;var t={operation:"check_item",id:this.id,state:this.state?"complete":"incomplete"};checklistApi.post(t,function(t,e){t?(this.state=!this.state,this.checkbox.prop("checked",this.state),alert(t.message),console.error(t.message),alert(t.message)):(this.container.toggleClass("checklist-item-state-complete"),this.container.find(".checklist-item-checked-at").text(e.checked_at))}.bind(this))}.bind(this)),this.container.find("a.checklist-btn").click(function(t){switch($(t.target).data("item-action")){case"edit":this.textInput.width(Math.max(this.textInput.width(),this.container.children(".checklist-item-text").width()+5)),this.container.addClass("checklist-item-edit-mode"),this.textInput.focus();break;case"cancel":this.cancel();break;case"save":this.saveText();break;case"delete":var e=Dict.S("UI:ChecklistItem:DeleteDlg:Msg"),i=this;$("<div>"+e+"</div>").dialog({modal:!0,title:Dict.S("UI:ChecklistItem:DeleteDlg:Title"),close:function(){$(this).remove()},minWidth:400,buttons:[{text:Dict.S("UI:ChecklistItem:DeleteDlg:Cancel"),click:function(){$(this).dialog("close")}},{text:Dict.S("UI:ChecklistItem:DeleteDlg:Delete"),click:function(){i.remove(),$(this).dialog("close")}}]})}}.bind(this)),this.textInput.keydown(function(t){13===t.keyCode?(t.preventDefault(),this.saveText()):27===t.keyCode&&(t.preventDefault(),this.cancel())}.bind(this))},ChecklistItem.prototype.saveText=function(){var t={operation:"edit_item",id:this.id,text:this.textInput.val()};if(""===t.text.trim())return this.textInput.focus();checklistApi.post(t,function(t,e){t?(alert(t.message),console.error(t.message)):(this.textInput.width(160),this.text=this.textInput.val(),this.container.children(".checklist-item-text").text(this.text),this.container.removeClass("checklist-item-edit-mode"))}.bind(this))},ChecklistItem.prototype.remove=function(){var t={operation:"remove_item",id:this.id};checklistApi.post(t,function(t,e){t?(alert(t.message),console.error(t)):this.container.parent("li").remove()}.bind(this))},ChecklistItem.prototype.cancel=function(){this.textInput.val(this.text).width(160),this.container.removeClass("checklist-item-edit-mode")},$(function(){$(".checklist").each(function(){new Checklist({container:this})}),$("[data-checklist-action='create_list']").click(function(){var t={operation:"create_list",edit_mode:"modify"===window.location.search.substr(1).split("&")[0].split("=")[1]?1:0};checklistApi.post(t,function(t,e){if(t)return alert(t.message),console.error(t.message);$(".checklist-new-list").before(e.html),new Checklist({id:e.id}).newItem()})});var t="select_checklist_template";const e=$(`<div id="ac_dlg_${t}"></div>`),i=($("body").append(e),new ExtKeyWidget(t,"ChecklistTemplate",checklistApi.oqlFilter,Dict.S("UI:Checklist:DlgPickATemplate"),!0,null,null,!0,!1,null));i.DoOk=function(){var t=window["oSelectedItems"+this.id+"_results"],t=(e.dialog("close"),{operation:"create_list_from_template",selected:t,edit_mode:"modify"===window.location.search.substr(1).split("&")[0].split("=")[1]?1:0});return checklistApi.post(t,function(t,e){if(t)return alert(t.message),console.error(t.message);$(".checklist-new-list").before(e.html),e.id.forEach(function(t){new Checklist({id:t})})}),!1},$("[data-checklist-action='create_list_from_template']").click(i.Search),window["oACWidget_"+t]=i});